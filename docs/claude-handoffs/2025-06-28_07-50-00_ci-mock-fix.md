# Vibe Dev CI Fix: Clean dist before tests

## For You (Human Coordinator)

The CI/CD is failing because Jest is loading the compiled JavaScript mock from `dist/__mocks__/` instead of the TypeScript mock from `src/__mocks__/`. This happens when running tests after a build.

## For Claude Code - COPY THIS ENTIRE SECTION

```bash
cd /Users/ehukaimedia/Desktop/AI-Applications/Node/vibe-dev
git pull origin main

# Check current test script
grep "test:" package.json

# The issue: dist folder has compiled mocks that Jest finds first
ls -la dist/src/__mocks__/ 2>/dev/null || echo "No dist mocks yet"

# Solution 1: Clean before test in CI
npm pkg set scripts.test:ci="npm run build && rm -rf dist/__mocks__ && jest --forceExit --detectOpenHandles --watchAll=false --maxWorkers=2 --testTimeout=30000 --coverage=false"

# Or Solution 2: Configure Jest to ignore dist for mocks
cat > jest.config.mjs << 'EOF'
export default {
  preset: 'ts-jest',
  testEnvironment: 'node',
  extensionsToTreatAsEsm: ['.ts'],
  moduleNameMapper: {
    '^(\\.{1,2}/.*)\\.js$': '$1',
  },
  transform: {
    '^.+\\.tsx?$': [
      'ts-jest',
      {
        useESM: true,
        tsconfig: {
          module: 'ESNext',
          target: 'ES2022',
          isolatedModules: true,
        },
      },
    ],
  },
  testMatch: ['<rootDir>/src/**/*.test.ts'],
  modulePathIgnorePatterns: ['<rootDir>/dist/'],
  moduleDirectories: ['node_modules', 'src'],
};
EOF

# Test locally first
npm test

# If that works, commit and push
git add -A
git commit -m "fix: prevent Jest from loading compiled mocks in CI

- Add modulePathIgnorePatterns to ignore dist folder
- Ensures TypeScript mocks are used, not compiled JS
- Fixes CI/CD test failures"

git push origin main
```