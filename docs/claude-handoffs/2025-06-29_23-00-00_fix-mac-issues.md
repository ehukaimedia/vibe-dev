# Mac Terminal Implementation Fixes - Critical Issues

## For Claude Code - Fix All Mac Issues Before PC Implementation

### Current Status
- OS-split implementation complete but Mac tests have issues
- Several tests failing that should pass on Mac
- Need to fix these BEFORE PC developer starts work

### Test Failures to Fix

#### 1. Mac Commands Test (`test/unit/mac-commands.test.ts`)
**Issue**: `ls -la` command returns empty output
**Expected**: Should return directory listing
**Fix**: Check output cleaning in `cleanOutput()` method - might be over-aggressive

#### 2. Path Handling Test (`test/unit/path-handling.test.ts`) 
**Issue**: Working directory tracking not working correctly
**Expected**: `pwd` after `cd /tmp` should return `/tmp`
**Actual**: Returns full prompt string with extra characters
**Fix**: The `workingDirectory` property needs proper extraction from PTY output

#### 3. Recap Types Test (`test/unit/recap-types.test.ts`)
**Issue**: Status recap missing "Recent Errors" section
**Fix**: Check vibe-recap.ts status formatting logic

#### 4. README Features Test (`test/integration/readme-features.test.ts`)
**Issue**: Multiple failures with environment variables, pipes, and recap
**Fix**: Session state persistence and command output parsing

#### 5. Coverage Test (`test/unit/vibe-terminal-coverage.test.ts`)
**Issue**: Test expects PowerShell on Mac (line 22)
**Fix**: This test needs platform-specific expectations

### Implementation Fixes Required

#### Fix 1: Update vibe-terminal-coverage.test.ts
```typescript
// Around line 20-25, fix the platform expectation
test('should detect correct shell type for platform', () => {
  const terminal = new VibeTerminal();
  const state = terminal.getSessionState();
  
  if (process.platform === 'darwin') {
    expect(['bash', 'zsh', 'fish', 'sh']).toContain(state.shellType);
  } else if (process.platform === 'win32') {
    expect(state.shellType).toBe('powershell');
  }
});
```

#### Fix 2: Improve cleanOutput in vibe-terminal-mac.ts
The current implementation might be removing too much. Check:
- Don't remove entire lines that contain commands
- Preserve actual command output
- Only clean prompt/control characters

#### Fix 3: Fix workingDirectory tracking in vibe-terminal-base.ts
Add proper PWD extraction after cd commands:
```typescript
// In execute method, after command completes
if (command.startsWith('cd ')) {
  // Update currentWorkingDirectory by running pwd
  const pwdResult = await this.execute('pwd');
  this.currentWorkingDirectory = pwdResult.output.trim();
}
```

#### Fix 4: Environment Variable Persistence
Ensure environment variables set with `export` persist across commands in the same session.

#### Fix 5: Fix Pipe Command Handling
Commands with pipes like `echo "test" | grep "test"` should work correctly.

### Testing Protocol

1. **Before Making Any Changes**:
   ```bash
   git status  # Ensure clean
   npm test 2>&1 | grep -E "(PASS|FAIL)" | wc -l  # Count current status
   ```

2. **After Each Fix**:
   ```bash
   npm test -- --testNamePattern="[specific test]"
   ```

3. **Final Verification**:
   ```bash
   npm test  # Should show MORE passing tests than before
   npm run build  # Must still pass
   ```

### Regression Prevention

#### DO NOT:
- Change vibe-recap.ts (except for the status format fix if needed)
- Modify the external API
- Break backward compatibility
- Change PC stub implementation
- Modify os-detector.ts

#### MUST:
- Keep all existing passing tests passing
- Fix Mac-specific test failures
- Maintain clean git history
- Test thoroughly before committing

### Expected Outcomes

After fixes:
- All Mac-specific tests should pass
- Integration tests should work on Mac
- No regression in existing functionality
- Clean test output (reduce console.error spam if possible)
- Ready for PC implementation phase

### Git Workflow

```bash
# 1. Create new branch from current
git checkout -b fix/mac-test-issues

# 2. Make fixes incrementally
# Fix one issue at a time and test

# 3. When all fixed
git add -A
git commit -m "fix: resolve Mac-specific test failures

- Fix shell detection test to expect Mac shells
- Improve output cleaning to preserve command results
- Fix working directory tracking after cd commands
- Ensure environment variables persist in session
- Handle piped commands correctly
- All Mac tests now passing"

# 4. Merge back to feature branch
git checkout feat/os-specific-terminals
git merge fix/mac-test-issues
git push origin feat/os-specific-terminals
```

### Success Criteria

- [ ] test/unit/mac-commands.test.ts - PASS
- [ ] test/unit/path-handling.test.ts - PASS  
- [ ] test/unit/recap-types.test.ts - PASS
- [ ] test/integration/readme-features.test.ts - PASS
- [ ] test/unit/vibe-terminal-coverage.test.ts - PASS
- [ ] No regression in other tests
- [ ] npm run build - SUCCESS
- [ ] Test count higher than 165/169

### Priority Order

1. Fix vibe-terminal-coverage.test.ts (easy win)
2. Fix cleanOutput to not remove command output
3. Fix working directory tracking
4. Fix environment variable persistence
5. Fix integration test issues

Remember: We need Mac working perfectly before PC starts their implementation!