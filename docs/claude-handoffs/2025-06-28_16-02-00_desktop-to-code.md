# Fix Failing Index Tests - Vibe Dev

## For You (Human Coordinator)
- Current issue: index.test.ts has 4 failing tests out of 6
- Root cause: The tests are importing index.js which runs immediately, but mocks aren't intercepting properly
- Priority: High - This is blocking our path to 100% test coverage
- Expected outcome: All 6 tests in index.test.ts should pass

## Issue Analysis

### Current Test Failures:
1. ❌ "should handle uncaught exceptions" - console.error not being called
2. ❌ "should start server successfully" - console.error not being called
3. ❌ "should handle server connection failure" - console.error not being called
4. ❌ "should handle fatal errors in runServer" - console.error not being called

### Root Cause:
The index.js file runs immediately when imported:
```javascript
// End of index.js
runServer().catch((error) => {
  console.error("Vibe Dev: Fatal error:", error);
  process.exit(1);
});
```

The test is setting up mocks AFTER importing modules, but index.js executes immediately, so the real implementations run before mocks are in place.

## Suggested Fix

### Option 1: Delay index.js execution (Recommended)
Modify index.ts to export the runServer function and only run it if the file is the main module:

```typescript
// index.ts
export async function runServer() {
  // ... existing runServer code ...
}

// Only run if this is the main module
if (import.meta.url === `file://${process.argv[1]}`) {
  runServer().catch((error) => {
    console.error("Vibe Dev: Fatal error:", error);
    process.exit(1);
  });
}
```

Then update the test to import and call runServer explicitly after mocks are set up.

### Option 2: Fix the test mocking order
Ensure all mocks are set up before ANY imports:

```typescript
// index.test.ts
import { describe, it, expect, jest, beforeEach, afterEach } from '@jest/globals';
import { EventEmitter } from 'events';

// Set up ALL mocks first
const mockTransport = { connect: jest.fn() };
const StdioServerTransport = jest.fn(() => mockTransport);

const mockServer = { 
  connect: jest.fn().mockResolvedValue(undefined)
};

await jest.unstable_mockModule('@modelcontextprotocol/sdk/server/stdio.js', () => ({
  StdioServerTransport
}));

await jest.unstable_mockModule('../../src/server.js', () => ({
  server: mockServer
}));

// Mock process before importing index
let mockProcess: any;
let originalProcess: NodeJS.Process;

beforeEach(() => {
  originalProcess = global.process;
  mockProcess = new EventEmitter() as any;
  mockProcess.exit = jest.fn();
  global.process = mockProcess as NodeJS.Process;
});

describe('Vibe Dev Index Entry Point', () => {
  // ... tests that import index.js dynamically ...
});
```

## For Claude Code - Implementation Steps

### If on Mac/Linux:
```bash
cd /Users/[username]/Desktop/AI-Applications/Node/vibe-dev
git pull
git status

# Check current test status
npm test test/unit/index.test.ts

# Apply the fix (Option 1 recommended)
# 1. Modify src/index.ts to export runServer and check if main module
# 2. Update test/unit/index.test.ts to import and call runServer after mocks

# Verify fix
npm test test/unit/index.test.ts  # Should show 6/6 passing

# Run all tests to ensure no regression
npm test
```

### If on Windows:
```powershell
cd C:\Users\[username]\Desktop\AI-Applications\Node\vibe-dev
git status

# This is a complex fix that should be done on Mac/Linux
# Create a test to verify the behavior once fixed
```

## Test Verification

After fixing, all 6 tests should pass:
- ✅ should handle SIGINT gracefully
- ✅ should handle uncaught exceptions  
- ✅ should start server successfully
- ✅ should handle server connection failure
- ✅ should handle fatal errors in runServer
- ✅ should be executable as a CLI script

## Success Metrics
- index.test.ts: 6/6 tests passing
- No regression in other tests
- Maintains CLI functionality (can still run `npx vibe-dev`)

## Next Steps After This Fix
According to the TDD plan:
1. Fix terminal.test.ts (13 tests) - Already 7 passing, fix remaining 6
2. Fix integration.test.ts (4 tests)
3. Handle edge case tests
4. Clean up empty test files

We're on track to reach 100% test coverage!