# Vibe Dev TDD Workflow Enhancement & Test Reorganization

## For You (Human Coordinator)
- Current issue: Test files are scattered in src/ when they should be in test/
- Impact: Violates clean architecture, makes test discovery harder, and clutters production code
- Priority: High - Essential for proper TDD workflow and regression-free evolution
- Expected outcome: All tests organized in test/ directory with proper categories

## Issue Details

**Current Behavior**:
- Test files scattered throughout src/ directory:
  - src/integration.test.ts
  - src/recap.test.ts  
  - src/terminal.test.ts
  - src/windows.test.ts
  - src/test/ (directory with 19 more test files)
- Empty test/ directory at project root
- Tests are passing (21/23) but organization violates TDD principles

**Expected Behavior**:
- All tests organized in test/ directory with clear categories:
  - test/unit/ - Unit tests for individual components
  - test/integration/ - Integration tests for workflows
  - test/performance/ - Performance benchmarks
  - test/fixtures/ - Test utilities and helpers
- No test files in src/ directory
- Updated jest.config.js to exclude src/test from builds

**Root Cause Hypothesis**:
- Tests were created ad-hoc without following the documented structure
- Missing enforcement of test organization standards
- TDD workflow document needs stronger enforcement mechanisms

## TDD Workflow Improvements Needed

### 1. Test Organization Enforcement
- Add pre-commit hook to prevent test files in src/
- Update jest.config.js to only look in test/ directory
- Add test organization validation script

### 2. Regression Prevention Mechanisms
- Implement baseline performance tracking
- Add test coverage thresholds
- Create test impact analysis for changes

### 3. Session-Based Evolution Tracking
- Automated STATUS.md updates with test metrics
- Performance regression alerts
- Test coverage delta reporting

## For Claude Code - COPY THIS ENTIRE SECTION

### If on Mac/Linux:
```bash
cd /Users/ehukaimedia/Desktop/AI-Applications/Node/vibe-dev
git status
npm test

# Verify current state
ls -la src/*.test.ts
ls -la src/test/
ls -la test/

# Create proper test structure
mkdir -p test/unit test/integration test/performance test/fixtures

# Move core test files from src to test/unit
mv src/terminal.test.ts test/unit/
mv src/recap.test.ts test/unit/
mv src/integration.test.ts test/integration/
mv src/windows.test.ts test/unit/

# Categorize and move tests from src/test/
# Unit tests (core functionality)
mv src/test/edge-cases-test.ts test/unit/
mv src/test/output-isolation-test.ts test/unit/
mv src/test/timeout-fix-test.ts test/unit/
mv src/test/recap-types-test.ts test/unit/
mv src/test/pty-test.ts test/unit/
mv src/test/mcp-protocol-test.ts test/unit/
mv src/test/mcp-tools-test.ts test/unit/

# Integration tests (workflows)
mv src/test/session-persistence-test.ts test/integration/
mv src/test/working-dir-tracking-test.ts test/integration/
mv src/test/windows-compatibility-test.ts test/integration/
mv src/test/for-loop-test.ts test/integration/
mv src/test/gh-cli-test.ts test/integration/
mv src/test/isolated-recap-test.ts test/integration/

# Test utilities to fixtures
mv src/test/test-helper.ts test/fixtures/
mv src/test/run-all-tests.ts test/fixtures/

# Move debug scripts to scripts/debug/
mkdir -p scripts/debug
mv src/test/debug-*.ts scripts/debug/
mv src/test/recap-demo.ts scripts/debug/

# Remove empty src/test directory
rmdir src/test

# Update imports in all moved test files
# For each test file, update imports from '../' to '../../src/'
# Example: '../vibe-terminal' becomes '../../src/vibe-terminal'

# Update jest.config.js to fix test paths
# Change testMatch to only look in test/ directory

# Run tests to verify everything still works
npm test

# Create test organization validator
cat > scripts/test/validate-organization.js << 'EOF'
#!/usr/bin/env node
import { readdirSync, statSync } from 'fs';
import { join } from 'path';

function findTestFiles(dir, files = []) {
  const items = readdirSync(dir);
  for (const item of items) {
    const path = join(dir, item);
    if (statSync(path).isDirectory() && !item.startsWith('.') && item !== 'node_modules') {
      findTestFiles(path, files);
    } else if (item.endsWith('.test.ts') || item.endsWith('.spec.ts')) {
      files.push(path);
    }
  }
  return files;
}

const srcTests = findTestFiles('src');
if (srcTests.length > 0) {
  console.error('❌ Test files found in src directory:');
  srcTests.forEach(f => console.error(`   ${f}`));
  process.exit(1);
} else {
  console.log('✅ No test files in src directory');
}
EOF

chmod +x scripts/test/validate-organization.js

# Add to package.json scripts
# "test:validate": "node scripts/test/validate-organization.js"

# Create performance baseline tracker
cat > test/fixtures/performance-baseline.ts << 'EOF'
export const PERFORMANCE_BASELINES = {
  vibe_terminal: {
    simple_echo: 100,     // ms
    complex_command: 500, // ms
    rapid_commands: 200,  // ms average
  },
  vibe_recap: {
    small_history: 50,    // ms
    large_history: 200,   // ms
    with_analysis: 500,   // ms
  }
};

export function assertPerformance(
  operation: string, 
  duration: number, 
  tolerance: number = 1.1
): void {
  const baseline = PERFORMANCE_BASELINES[operation];
  if (!baseline) {
    throw new Error(`No baseline for operation: ${operation}`);
  }
  
  const maxAllowed = baseline * tolerance;
  if (duration > maxAllowed) {
    throw new Error(
      `Performance regression: ${operation} took ${duration}ms ` +
      `(baseline: ${baseline}ms, max: ${maxAllowed}ms)`
    );
  }
}
EOF

# Update TDD-WORKFLOW.md with enforcement section
# Add pre-commit hook setup instructions
# Add test coverage requirements

# Verify final state
find test -name "*.test.ts" -o -name "*.spec.ts" | sort
npm test

# Commit the reorganization
git add -A
git commit -m "refactor: reorganize tests into proper test/ directory structure

- Move all test files from src/ to test/
- Create unit/, integration/, performance/, fixtures/ categories
- Add test organization validator
- Update imports to use correct paths
- Add performance baseline tracking
- Improve TDD workflow enforcement"
```

### If on Windows:
```powershell
cd C:\Users\[username]\Desktop\AI-Applications\Node\vibe-dev
git status
npm test

# Similar commands adapted for Windows PowerShell
# Use Move-Item instead of mv
# Use New-Item -ItemType Directory instead of mkdir -p
# Adjust paths to use backslashes
```

## Verification Commands
```bash
# Verify no tests in src
find src -name "*.test.ts" -o -name "*.spec.ts"

# Verify test organization
tree test -I node_modules

# Run all tests
npm test

# Check test coverage
npm run test:coverage

# Validate organization
npm run test:validate
```

## Expected Metrics After Implementation
- Tests organized: 100% in test/ directory
- Test categories: 4 (unit, integration, performance, fixtures)
- Build size: Reduced (no test files in dist/)
- Test discovery: Improved
- TDD compliance: Enhanced