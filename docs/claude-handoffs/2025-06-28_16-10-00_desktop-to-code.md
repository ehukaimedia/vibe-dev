# Fix Terminal Test Mocking Issues - Vibe Dev

## For You (Human Coordinator)
- Current issue: terminal.test.ts has 6 failing tests out of 13
- Root cause: Real terminal instances are being created instead of using mocks
- Priority: High - Part of our path to 100% test coverage
- Expected outcome: All 13 tests in terminal.test.ts should pass

## Issue Analysis

### Current Test Failures:
1. ❌ "should execute commands and return output" - Expected "Hello World", got "$"
2. ❌ "should track working directory" - Expected "/mock/directory", got actual directory
3. ❌ "should handle command timeout" - Expected exit code -1, got 0
4. ❌ "should persist state between commands" - Expected "123", got "$"
5. ❌ "should clean output properly" - Output contains "$" prompt
6. ❌ "should handle PTY exit events" - mockPty.onExit is undefined

### Root Cause:
The tests are creating real VibeTerminal instances that spawn actual terminal processes instead of using the mocked node-pty. The mock is set up correctly but not being used.

### Evidence:
From the test output, we see console.error messages like:
```
Vibe Terminal: Created session xxx with zsh shell (PID: 63037)
```
This shows real terminals are being created.

## The Problem

The mock is set up correctly:
```typescript
await jest.unstable_mockModule('node-pty', () => ({
  spawn: mockPtySpawn
}));
```

But when VibeTerminal is imported and instantiated, it's still using the real node-pty.

## Suggested Fix

### 1. Verify mock is being used
Add logging to confirm the mock is called:
```typescript
mockPtySpawn.mockImplementation((shell, args, opts) => {
  console.log('Mock PTY spawn called!', { shell, args, opts });
  return mockPty;
});
```

### 2. Fix the mock responses
The current mock simulates full terminal output with prompts, but VibeTerminal cleans this. Update mocks to match what the tests expect:

```typescript
// Current mock response
dataCallback(`${cmd}\r\nHello World\r\n$ `);

// What tests expect (after VibeTerminal cleaning)
dataCallback('Hello World');
```

### 3. Or fix the tests to match reality
If VibeTerminal is supposed to return raw output, update test expectations:
```typescript
// Instead of
expect(result.output).toBe('Hello World');

// Use
expect(result.output).toContain('Hello World');
// or check the cleaned output
```

## For Claude Code - Implementation Steps

### If on Mac/Linux:
```bash
cd /Users/[username]/Desktop/AI-Applications/Node/vibe-dev
git pull
git status

# Check current test status
npm test test/unit/terminal.test.ts

# Debug why mocks aren't working
# 1. Add console.log to mockPtySpawn to verify it's called
# 2. Check if VibeTerminal is caching the real node-pty import
# 3. Ensure mock is set up before ANY imports

# Potential fixes:
# Option A: Fix the mock to not be intercepted
# - Clear module cache before test
# - Ensure VibeTerminal imports are dynamic

# Option B: Fix mock responses to match expected output
# - Update mock to return clean output without prompts
# - Match the output cleaning logic in VibeTerminal

# Option C: Update tests to match actual behavior
# - Change expectations to match real output format

# Verify fix
npm test test/unit/terminal.test.ts  # Should show 13/13 passing

# Ensure no regression
npm test
```

### Key Investigation Points:
1. Why is `new VibeTerminal()` creating real terminals instead of using mocks?
2. Is there a module caching issue preventing the mock from being used?
3. What is the actual output format from VibeTerminal vs what tests expect?

## Test Verification

After fixing, all 13 tests should pass:
- ✅ should create a session with unique ID
- ✅ should execute commands and return output
- ✅ should track working directory
- ✅ should handle command timeout
- ✅ should persist state between commands
- ✅ should maintain command history
- ✅ should clean output properly
- ✅ should handle multiple commands in sequence
- ✅ should detect shell type
- ✅ should handle errors gracefully
- ✅ should clean up on kill
- ✅ should handle PTY data events
- ✅ should handle PTY exit events

## Success Metrics
- terminal.test.ts: 13/13 tests passing
- No real terminals spawned during tests
- Tests run quickly (< 1 second)
- No hanging processes

## Next Steps After This Fix
1. Fix integration tests (4 tests)
2. Fix remaining edge case tests
3. Clean up empty test files
4. Achieve 100% test coverage!

## Note on Output Cleaning
VibeTerminal appears to clean terminal output by removing prompts and control characters. The tests should either:
1. Mock the cleaned output directly, or
2. Expect the raw output format

Check the actual `cleanOutput` method in VibeTerminal to understand the expected format.