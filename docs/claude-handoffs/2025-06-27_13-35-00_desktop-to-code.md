# Vibe Dev Critical Fix: GitHub CLI Compatibility

## For You (Human Coordinator)

We've discovered that vibe_terminal fails with GitHub CLI (`gh`) commands. This is because `gh` sends terminal capability queries that our PTY implementation doesn't handle.

## Issue Summary
- vibe_terminal outputs `]11;?\[6n` (terminal capability queries) and times out
- These are standard terminal protocol requests that need responses
- This is NOT a problem with using PTY - it's about handling terminal protocols properly

## ⚠️ IMPORTANT: Do NOT Replace PTY with Spawn!

Desktop Commander uses a different approach (spawn instead of PTY), which is why it doesn't have this issue. However, **we do NOT want to copy their approach** because:

1. **PTY is more powerful** - supports interactive programs (vim, ssh, etc.)
2. **PTY maintains state** - cd, environment variables persist
3. **PTY is vibe-dev's core feature** - it's what makes us special!

The solution is to make our PTY implementation handle terminal queries properly, NOT to abandon it.

## For Claude Code - COPY THIS ENTIRE SECTION

```bash
cd /Users/ehukaimedia/Desktop/AI-Applications/Node/vibe-dev

# First, see the issue yourself
npm run build
node -e "
const { executeTerminalCommand } = require('./dist/src/vibe-terminal.js');
executeTerminalCommand('gh --version').then(r => console.log('Result:', r));
"

# The issue: gh sends these terminal queries:
# ]11;? = "What's your background color?"
# [6n = "Where's your cursor?"

# Our PTY doesn't answer, so gh waits forever

# DO NOT look at Desktop Commander's implementation
# They use spawn which avoids the issue but loses PTY features

# CORRECT SOLUTION: Handle terminal queries in our PTY

# Create test file
cat > src/test/gh-compatibility-test.ts << 'EOF'
import { executeTerminalCommand } from '../vibe-terminal.js';

async function testGhCommands() {
  console.log('Testing GitHub CLI compatibility...\n');
  
  const tests = [
    'gh --version',
    'gh auth status',
    'echo "test" | head -1',  // This should work fine
    'vim --version',          // This needs PTY to work properly
  ];
  
  for (const cmd of tests) {
    console.log(`Testing: ${cmd}`);
    try {
      const result = await executeTerminalCommand(cmd);
      console.log(`✓ Exit: ${result.exitCode}, Output: ${result.output.slice(0, 50)}...`);
    } catch (err) {
      console.log(`✗ Failed:`, err);
    }
  }
}

testGhCommands();
EOF

# The fix should be in vibe-terminal.ts, something like:
# 1. Detect terminal queries in PTY data
# 2. Respond appropriately
# 3. Or set environment to disable queries

# Option 1: Handle queries (BEST)
# In PTY data handler, detect and respond:
# if (data.includes('\x1b]11;?')) {
#   this.pty.write('\x1b]11;rgb:0000/0000/0000\x07');
# }

# Option 2: Disable queries (ACCEPTABLE)
# Add to PTY env:
# TERM: 'dumb' or GH_FORCE_TTY: '0'

# After implementing fix
npm run build
node dist/src/test/gh-compatibility-test.js

# Test that PTY features still work
node -e "
const { executeTerminalCommand } = require('./dist/src/vibe-terminal.js');
executeTerminalCommand('cd /tmp && pwd').then(r => console.log('CD test:', r.output));
"

# Verify fix works
git add -A
git commit -m "Fix gh CLI compatibility by handling terminal capability queries in PTY"
git push
```

## Correct Approaches (in order of preference)

### 1. Handle Terminal Queries (BEST)
Make PTY respond to terminal capability requests:
```typescript
// In vibe-terminal.ts PTY setup
this.pty.onData((data) => {
  // Check for terminal queries and respond
  if (data.includes('\x1b]11;?\x07')) {
    // Respond with background color
    this.pty.write('\x1b]11;rgb:0000/0000/0000\x07');
  }
  if (data.includes('\x1b[6n')) {
    // Respond with cursor position
    this.pty.write('\x1b[1;1R');
  }
  // ... existing output handling
});
```

### 2. Configure Environment (GOOD)
Tell programs not to use advanced terminal features:
```typescript
env: { 
  ...process.env,
  ...config.env,
  TERM: 'dumb',        // Minimal terminal
  GH_FORCE_TTY: '0',   // GitHub CLI specific
  NO_COLOR: '1',       // Disable colors
}
```

### 3. Smart Detection (ADVANCED)
Detect problematic commands and adjust:
```typescript
// Before executing
const problematicCLIs = ['gh', 'aws', 'gcloud'];
const baseCommand = command.split(' ')[0];

if (problematicCLIs.includes(baseCommand)) {
  // Add specific environment variables
  this.pty.env.GH_FORCE_TTY = '0';
}
```

## What NOT to Do

❌ Do NOT replace PTY with spawn
❌ Do NOT copy Desktop Commander's approach
❌ Do NOT remove virtual terminal features
❌ Do NOT make vibe_terminal "dumber"

## Success Criteria
- ✅ gh commands work without timeout
- ✅ No terminal escape sequences in output
- ✅ Interactive commands (vim, ssh) still work
- ✅ Session persistence maintained
- ✅ PTY features preserved

## Why This Matters
The virtual terminal (PTY) is what makes vibe-dev special. We just need to make it smarter about handling terminal protocols, not abandon it for a simpler approach!