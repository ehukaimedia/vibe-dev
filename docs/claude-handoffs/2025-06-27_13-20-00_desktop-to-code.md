# Vibe Dev Critical Fix: GitHub CLI Compatibility

## For You (Human Coordinator)

We've discovered that vibe_terminal fails with GitHub CLI (`gh`) commands while Desktop Commander's execute_command works fine. This is a critical issue that needs immediate fixing.

## Issue Summary
- vibe_terminal outputs `]11;?\[6n` and times out with gh commands
- This is a terminal capability detection sequence that's not being handled
- execute_command works perfectly with the same commands
- This undermines vibe-dev's core value proposition

## Important Reference
Study how Desktop Commander handles command execution:
`/Users/ehukaimedia/Desktop/AI-Applications/Node/DesktopCommanderMCP-Recap/src/tools/execute.ts`

Key differences:
- Desktop Commander uses `spawn` from Node's `child_process`
- vibe-dev uses `node-pty` which creates a pseudo-terminal
- `spawn` doesn't trigger terminal capability negotiation
- PTY is more powerful but requires handling terminal queries

## For Claude Code - COPY THIS ENTIRE SECTION

```bash
cd /Users/ehukaimedia/Desktop/AI-Applications/Node/vibe-dev

# First, see the issue yourself
npm run build
node -e "
const { executeTerminalCommand } = require('./dist/src/vibe-terminal.js');
executeTerminalCommand('gh --version').then(r => console.log('Result:', r));
"

# Check current PTY configuration
grep -n "pty.spawn" src/vibe-terminal.ts
grep -n "env:" src/vibe-terminal.ts
grep -n "TERM" src/vibe-terminal.ts

# Test with other interactive commands
node -e "
const { executeTerminalCommand } = require('./dist/src/vibe-terminal.js');
executeTerminalCommand('npm --version').then(r => console.log('NPM:', r));
executeTerminalCommand('git --version').then(r => console.log('Git:', r));
"

# Research the escape sequences
# ]11;? = OSC 11 - Request background color
# [6n = DSR - Device Status Report (cursor position)

# Study Desktop Commander's approach
cat /Users/ehukaimedia/Desktop/AI-Applications/Node/DesktopCommanderMCP-Recap/src/tools/execute.ts
cat /Users/ehukaimedia/Desktop/AI-Applications/Node/DesktopCommanderMCP-Recap/src/terminal-manager.ts

# Key insight: Desktop Commander uses spawn() not PTY
# This avoids terminal capability negotiation entirely
# Consider hybrid approach: PTY for interactive, spawn for tools

# Potential fixes to try:
# 1. Set TERM environment variable
# 2. Add --non-interactive flag to gh
# 3. Filter ANSI sequences in output
# 4. Respond to terminal queries

# Create test file
cat > src/test/gh-compatibility-test.ts << 'EOF'
import { executeTerminalCommand } from '../vibe-terminal.js';

async function testGhCommands() {
  console.log('Testing GitHub CLI compatibility...\n');
  
  const tests = [
    'gh --version',
    'gh auth status',
    'gh run list --repo ehukaimedia/vibe-dev --limit 1 --json status',
  ];
  
  for (const cmd of tests) {
    console.log(`Testing: ${cmd}`);
    try {
      const result = await executeTerminalCommand(cmd);
      console.log(`âœ“ Exit: ${result.exitCode}, Output: ${result.output.slice(0, 50)}...`);
    } catch (err) {
      console.log(`âœ— Failed:`, err);
    }
  }
}

testGhCommands();
EOF

# After implementing fix
npm run build
node dist/src/test/gh-compatibility-test.js

# Verify fix works
git add -A
git commit -m "Fix gh CLI compatibility - handle terminal capability queries"
git push
```

## Suggested Fixes (in order of preference)

### Option 0: Learn from Desktop Commander (NEW)
Desktop Commander avoids this issue entirely by using `spawn` instead of PTY:
```typescript
// Desktop Commander approach (no terminal emulation)
const process = spawn(command, [], { shell: true });

// vs vibe-dev approach (full terminal emulation)  
this.pty = pty.spawn(defaultShell, [], {
  name: 'xterm-256color',
  // ... triggers terminal capability queries
});
```

Consider adding a "simple mode" for commands like `gh` that don't need PTY features.

1. **Set proper TERM environment**:
```typescript
env: { 
  ...process.env, 
  TERM: 'xterm-256color',
  GH_NO_INTERACTIVE: '1',  // Force non-interactive mode
}
```

2. **Filter terminal queries from output**:
```typescript
// Filter out terminal capability queries
data = data.replace(/\x1b\]11;\?\x07/g, ''); // OSC 11
data = data.replace(/\x1b\[6n/g, '');        // DSR
```

3. **Respond to terminal queries**:
```typescript
if (data.includes('\x1b[6n')) {
  this.pty.write('\x1b[0;0R'); // Cursor at 0,0
}
```

## Success Criteria
- gh commands work without timeout
- No escape sequences in output
- All gh operations function correctly
- Other interactive CLIs still work

## Priority: CRITICAL
This blocks developers from using gh with vibe-dev!