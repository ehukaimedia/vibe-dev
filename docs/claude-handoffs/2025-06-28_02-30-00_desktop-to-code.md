# Vibe Dev CI/CD Test Hanging Issue - Urgent Fix Needed

## For You (Human Coordinator)

**Issue**: CI/CD tests are hanging despite environment variable fixes. All 8 jobs get stuck at "Run tests" step for 30+ minutes.

**What We've Tried**:
1. ✅ Fixed gh CLI with environment variables (CI=true, GH_FORCE_TTY=0)
2. ✅ Added all CI environment variables to Codex environment
3. ❌ Tests still hang in GitHub Actions

**Current State**: 
- Cancelled all hanging runs
- Tests hang on all platforms (Ubuntu, Windows, macOS)
- Codex environment is configured correctly but tests still hang

**Expected Outcome**: Tests should complete within 5-10 minutes on all platforms.

## For Claude Code - COPY THIS ENTIRE SECTION

```bash
cd /Users/ehukaimedia/Desktop/AI-Applications/Node/vibe-dev
git pull origin main

# 1. Check current test configuration
cat package.json | grep -A 5 '"scripts"'
cat jest.config.js

# 2. Run tests locally to see what hangs
npm test -- --listTests
timeout 30 npm test -- --verbose --detectOpenHandles

# 3. Create a test timeout fix
cat > test-timeout-fix.patch << 'EOF'
--- a/package.json
+++ b/package.json
@@ -X,X +X,X @@
   "scripts": {
-    "test": "jest",
+    "test": "jest --forceExit --detectOpenHandles --watchAll=false --maxWorkers=2 --testTimeout=30000",
+    "test:ci": "CI=true jest --forceExit --detectOpenHandles --watchAll=false --maxWorkers=2 --testTimeout=30000 --coverage=false",
EOF

# 4. Check for interactive tests
grep -r "readline" src/ test/ || echo "No readline found"
grep -r "prompt" src/ test/ || echo "No prompt found"
grep -r "process.stdin" src/ test/ || echo "No stdin found"
grep -r "inquirer" src/ test/ || echo "No inquirer found"

# 5. Look for PTY-specific test issues
grep -r "pty" test/ || echo "No pty references in tests"
grep -r "spawn" test/ || echo "No spawn references in tests"

# 6. Create a minimal test to verify CI works
cat > test/ci-smoke.test.js << 'EOF'
describe('CI Smoke Test', () => {
  it('should complete without hanging', () => {
    expect(true).toBe(true);
  });
  
  it('should have CI environment', () => {
    expect(process.env.CI).toBe('true');
  });
});
EOF

# 7. Update GitHub workflow with timeout
cat .github/workflows/cross-platform-test.yml | head -50

# 8. Test with explicit timeout
CI=true timeout 60 npm test -- --testPathPattern=ci-smoke

# 9. If tests still hang, add debug logging
export DEBUG=vibe-dev:*
CI=true timeout 30 npm test -- --verbose 2>&1 | tee test-output.log

# 10. Check what's in the test output
tail -50 test-output.log
```

## Key Areas to Investigate

1. **Jest Configuration**: Ensure Jest isn't in watch mode
2. **PTY Tests**: Any tests that create PTY sessions might hang
3. **Interactive Prompts**: Remove or mock any interactive elements
4. **Test Timeouts**: Add explicit timeouts to prevent infinite hangs

## Recommended Fixes

1. **Update package.json**:
   - Add `--forceExit --watchAll=false` to test script
   - Create separate `test:ci` script with all CI flags
   
2. **Update jest.config.js**:
   - Add `testTimeout: 30000`
   - Ensure `watchman: false`
   
3. **Update GitHub workflow**:
   - Add `timeout-minutes: 10` to test step
   - Use `npm run test:ci` instead of `npm test`

4. **Mock PTY interactions**:
   - Mock any spawn or PTY creation in tests
   - Use test doubles for terminal interactions

## Verification Steps

After implementing fixes:
```bash
# Test locally with CI environment
CI=true npm test

# Commit and push
git add -A
git commit -m "fix: prevent test hangs in CI with proper Jest configuration"
git push origin main

# Monitor new CI run
gh run list --repo ehukaimedia/vibe-dev --limit 1
gh run watch <new-run-id> --repo ehukaimedia/vibe-dev
```

## Success Criteria

- All tests complete within 10 minutes
- No hanging on "Run tests" step
- All platforms (Ubuntu, Windows, macOS) pass
